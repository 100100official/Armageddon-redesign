<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two Earths WebGL Demo - Part 2</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nico+Moji&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap">
    <style>
        @font-face {
            font-family: 'Nico Moji';
            font-style: normal;
            font-weight: 400;
            src: url(//fonts.gstatic.com/ea/nicomoji/v1/NicoMoji-Regular.eot);
            src: url(//fonts.gstatic.com/ea/nicomoji/v1/NicoMoji-Regular.eot?#iefix) format('embedded-opentype'),
                url(//fonts.gstatic.com/ea/nicomoji/v1/NicoMoji-Regular.woff2) format('woff2'),
                url(//fonts.gstatic.com/ea/nicomoji/v1/NicoMoji-Regular.woff) format('woff'),
                url(//fonts.gstatic.com/ea/nicomoji/v1/NicoMoji-Regular.ttf) format('truetype');
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            overflow: hidden;
            background: black;
            font-family: 'Nico Moji', sans-serif;
        }

        h1, h2 {
            font-size: 18px;
            text-align: center;
            color: white;
            font-family: 'Nico Moji', sans-serif;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }

        #frame {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80vw;
            height: 80vh;
            border: 3px solid limegreen;
            transform: translate(-50%, -50%);
            box-sizing: border-box;
            pointer-events: none;
        }

        #controls {
            position: absolute;
            bottom: 55px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            font-family: 'Nico Moji', sans-serif;
        }

        .control-button {
            background-color: limegreen;
            border: none;
            color: black;
            padding: 5px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'Nico Moji', sans-serif;
        }

        .control-button:active {
            background-color: darkgreen;
        }

        #observation-details {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: limegreen;
            text-align: center;
            font-size: 16px;
            z-index: 10;
            font-family: 'Nico Moji', sans-serif;
        }

        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: limegreen;
            text-align: center;
            font-size: 16px;
            z-index: 20;
            font-family: 'Nico Moji', sans-serif;
        }

        /* 추가된 CSS 스타일 */
        body.hidden {
            background-color: black;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        svg {
            font-family: "Audiowide", cursive;
            position: absolute;
            width: 100%;
            height: 100%;
            filter: url(#screen-noise);
        }

        body:before {
            content: " ";
            position: absolute;
            z-index: 10;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background-image: linear-gradient(
                    0deg,
                    transparent 50%,
                    rgba(0, 0, 0, 0.8) 10%
                ),
                linear-gradient(90deg, transparent 80%, rgba(0, 0, 0, 0.8) 10%);
            background-size: 3px 3px;
        }

        svg text {
            text-transform: uppercase;
            fill: red;
            font-size: 24px;
            filter: url(#Glow);
        }

        .crt-screen {
            width: 100%;
            height: 100%;
        }

        .hidden {
            display: none;
        }

        /* 손전등 효과 추가 */
        .flashlight {
            position: fixed;
            top: 0;
            left: 0;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.7) 10%, transparent 50%);
            pointer-events: none;
            mix-blend-mode: screen;
            transform: translate(-50%, -50%);
            z-index: 20;
        }
    </style>
</head>

<body>
    <canvas id="scene"></canvas>
    <div id="message"></div>

    <!-- 추가된 SVG 요소 -->
    <div class="crt-screen hidden">
        <svg id="initial-svg" viewBox="0 0 300 200" xmlns='http://www.w3.org/2000/svg'>
            <defs>
                <filter id='screen-noise'>
                    <feTurbulence type='turbulence' result='noise' baseFrequency='0.2' numOctaves='1' seed='2' stitchTiles='noStitch' />
                    <feOffset dy="0" dx="0">
                        <animate attributeName="dy" values="0;-20" dur=".1s" begin="0s" repeatCount="indefinite" />
                        <animate attributeName="dx" values="0;20" dur=".3s" begin="0s" repeatCount="indefinite" />
                    </feOffset>
                    <feComponentTransfer>
                        <feFuncR type="linear" slope="1" intercept="-0.4" />
                        <feFuncG type="linear" slope="1" intercept="-0.4" />
                        <feFuncB type="linear" slope="1" intercept="-0.4" />
                    </feComponentTransfer>
                    <feBlend in="SourceGraphic" in2="noiseElement" mode="multiply" result="screen-content" />
                    <feTurbulence baseFrequency="0.01 1" result="waves" numOctaves="2" />
                    <feDisplacementMap in="screen-content" in2="waves" scale="2" xChannelSelector="R" yChannelSelector="R">
                        <animate attributeName="scale" values="0;10;0;50;5" dur="3s" begin="0s" repeatCount="indefinite" />
                    </feDisplacementMap>
                </filter>
                <filter id="Glow" x="-30%" y="-30%" width="160%" height="160%">
                    <feGaussianBlur stdDeviation="6 2" result="glow" />
                    <feMerge>
                        <feMergeNode in="glow" />
                        <feMergeNode in="SourceGraphic" />
                    </feMerge>
                </filter>
                <pattern id="Grid" x="0" y="0" width="0.2" height="0.2">
                    <rect x="0" y="0" width="100px" height="100px" stroke='blue' fill='transparent' stroke-width='2' />
                    <rect x="2" y="0" width="100px" height="100px" stroke='green' fill='transparent' stroke-width='2' />
                    <animateTransform attributeType="xml" attributeName="patternTransform" type="translate" values="0,0;60,40" dur="5s" begin="0s" repeatCount="indefinite" />
                </pattern>
            </defs>
            <rect height="100%" width="100%" fill="url(#Grid)" filter="url(#Glow)" />
            <text x="50%" y="50%" text-anchor="middle" dy="0.35em">
                <tspan x="50%" dy="0">I'M LIKE</tspan>
            </text>
        </svg>

        <!-- Hidden SVG that will be shown after 9 seconds -->
        <svg id="duplicate-svg" viewBox="0 0 300 200" xmlns='http://www.w3.org/2000/svg' class="hidden">
            <rect height="100%" width="100%" fill="url(#Grid)" filter="url(#Glow)" />
            <text x="50%" y="25%" dy=".35em" text-anchor="middle">
                <tspan x="50%" dy="-0.35em">SOME KIND OF</tspan>
                <tspan x="50%" dy="1.2em">SUPERNOVA</tspan>
            </text>
            <text x="50%" y="75%" dy=".35em" text-anchor="middle">
                <tspan x="50%" dy="-0.35em">SOME KIND OF</tspan>
                <tspan x="50%" dy="1.2em">SUPERNOVA</tspan>
            </text>
        </svg>
    </div>

    <!-- Audio 요소 추가 -->
    <audio id="background-music" src="supernova/Supernova_drum.mp3" preload="auto"></audio>

    <!-- 손전등 효과 요소 추가 -->
    <div class="flashlight" id="flashlight"></div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.128.0';
        import { OrbitControls } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/controls/OrbitControls.js';
        import {
          EffectComposer,
          Pass,
          FullScreenQuad
        } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'https://cdn.skypack.dev/three@0.128.0/examples/jsm/postprocessing/RenderPass.js';
        import { LensDistortionPassGen } from 'https://cdn.jsdelivr.net/gh/ycw/three-lens-distortion@1.0.0/src/index.js';
        import { DualBloomPassGen } from 'https://cdn.jsdelivr.net/gh/ycw/three-dual-bloom@1.1.6/src/index.js';
        import * as topojson from 'https://cdn.skypack.dev/topojson@3';

        document.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('background-music');
            const flashlight = document.getElementById('flashlight');

            // 페이지 로드 후 첫 클릭 시 음원 재생
            document.body.addEventListener('click', () => {
                audio.play().catch(error => {
                    console.log('Audio playback failed:', error);
                });
            }, { once: true });

            // 손전등 효과
            document.addEventListener('mousemove', (e) => {
                flashlight.style.left = `${e.clientX}px`;
                flashlight.style.top = `${e.clientY}px`;
            });

            class App {
                constructor({ canvas }) {
                    this.canvas = canvas;
                    this.sizes = {
                        viewport: {
                            width: window.innerWidth,
                            height: window.innerHeight
                        }
                    };

                    this.init();
                }

                async init() {
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x000000);

                    this.camera = new THREE.PerspectiveCamera(70, this.sizes.viewport.width / this.sizes.viewport.height, 1, 1000);
                    this.camera.position.z = 5;

                    this.renderer = new THREE.WebGLRenderer({
                        canvas: this.canvas,
                        antialias: true
                    });
                    this.renderer.setPixelRatio(window.devicePixelRatio);
                    this.renderer.setSize(this.sizes.viewport.width, this.sizes.viewport.height);
                    window.addEventListener('resize', () => this.handleResize(), { passive: true });

                    this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enablePan = false;
                    this.controls.enableZoom = false;

                    this.originalEarth = await this.createEarth(0xffffff, 0);
                    this.scene.add(this.originalEarth);

                    this.blueEarth = await this.createEarth(0x0000ff, 10);
                    this.scene.add(this.blueEarth);

                    this.initPostProcessing();

                    this.camera.position.set(this.blueEarth.position.x, this.blueEarth.position.y, this.blueEarth.position.z + 5);
                    this.controls.target.copy(this.blueEarth.position);
                    this.controls.update();

                    this.applyDistortionEffect();

                    // Disable click action on the canvas
                    this.canvas.style.pointerEvents = 'none';

                    this.typeMessage("can't stop hyperstellar", () => {
                        // Enable click action on the canvas after the message animation completes
                        this.canvas.style.pointerEvents = 'auto';
                    });

                    this.render();
                }

                typeMessage(message, callback) {
                    const messageElement = document.getElementById('message');
                    if (messageElement) {
                        messageElement.style.display = 'block';
                        messageElement.textContent = '';
                        let index = 0;
                        const interval = setInterval(() => {
                            messageElement.textContent += message[index];
                            index++;
                            if (index === message.length) {
                                clearInterval(interval);
                                if (callback) callback(); // Call the callback function if provided
                            }
                        }, 100);
                    } else {
                        console.error("Element with id 'message' not found.");
                    }
                }

                async createEarth(color, xPosition) {
                    const response = await fetch("https://cdn.jsdelivr.net/npm/world-atlas@1/world/50m.json");
                    const topology = await response.json();
                    const mesh = topojson.mesh(topology, topology.objects.land);
                    const material = new THREE.LineBasicMaterial({ color: color });
                    const earth = this.wireframe(mesh, 1.25, material);
                    earth.position.set(xPosition, 0, 0);
                    return earth;
                }

                wireframe(multilinestring, radius, material) {
                    const geometry = new THREE.BufferGeometry();
                    const vertices = [];
                    for (const P of multilinestring.coordinates) {
                        for (let p0, p1 = this.vertex(P[0], radius), i = 1; i < P.length; ++i) {
                            p0 = p1;
                            p1 = this.vertex(P[i], radius);
                            vertices.push(p0.x, p0.y, p0.z, p1.x, p1.y, p1.z);
                        }
                    }
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                    return new THREE.LineSegments(geometry, material);
                }

                vertex([longitude, latitude], radius) {
                    const lambda = longitude * Math.PI / 180;
                    const phi = latitude * Math.PI / 180;
                    return new THREE.Vector3(
                        radius * Math.cos(phi) * Math.cos(lambda),
                        radius * Math.sin(phi),
                        -radius * Math.cos(phi) * Math.sin(lambda)
                    );
                }

                handleResize() {
                    this.sizes.viewport.width = window.innerWidth;
                    this.sizes.viewport.height = window.innerHeight;
                    this.camera.aspect = this.sizes.viewport.width / this.sizes.viewport.height;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(this.sizes.viewport.width, this.sizes.viewport.height);
                    this.composer.setSize(this.sizes.viewport.width, this.sizes.viewport.height);
                }

                initPostProcessing() {
                    const deps = { THREE, Pass, FullScreenQuad };
                    const LensDistortionPass = LensDistortionPassGen(deps);
                    this.lensDistortionPass = new LensDistortionPass({
                        distortion: new THREE.Vector2(-1, -1),
                        focalLength: new THREE.Vector2(2, 2),
                        skew: 0,
                        principalPoint: new THREE.Vector2(0, 0)
                    });
                    this.lensDistortionPass.enabled = true;
                    const DualBloomPass = DualBloomPassGen(deps);
                    this.dualBloomPass = new DualBloomPass({
                        threshold: 0.1,
                        blurriness: 4.0,
                        intensity: 5
                    });
                    this.dualBloomPass.enabled = true;

                    this.composer = new EffectComposer(this.renderer);
                    this.composer.addPass(new RenderPass(this.scene, this.camera));
                    this.composer.addPass(this.lensDistortionPass);
                    this.composer.addPass(this.dualBloomPass);
                }

                applyDistortionEffect() {
                    this.startAutoCameraMovement();
                }

                startAutoCameraMovement() {
                    const movementSpeed = 0.0025;
                    let elapsedTime = 0;
                    const duration = 5000;
                    const initialZ = 5;
                    const targetZ = 0;

                    const moveCamera = () => {
                        if (elapsedTime < duration) {
                            this.camera.rotation.y += movementSpeed;
                            const progress = elapsedTime / duration;
                            this.camera.position.z = initialZ * (1 - progress) + targetZ * progress;
                            elapsedTime += 16;
                            requestAnimationFrame(moveCamera);
                        } else {
                            this.camera.position.z = targetZ;
                            // window.location.href = 'page4.html'; 페이지 이동 대신에 페이지 4의 내용을 이어서 실행
                            this.showPage4Content();
                        }
                    };

                    requestAnimationFrame(moveCamera);
                }

                showPage4Content() {
                    // 기존 페이지 2의 컨텐츠를 숨기고 페이지 4의 컨텐츠를 보여줍니다.
                    document.querySelector('canvas').classList.add('hidden');
                    const messageElement = document.getElementById('message');
                    messageElement.classList.add('hidden');
                    messageElement.textContent = '';  // 메시지 초기화
                    document.querySelector('.crt-screen').classList.remove('hidden');

                    setTimeout(() => {
                        document.getElementById('initial-svg').classList.add('hidden');
                        document.getElementById('duplicate-svg').classList.remove('hidden');
                    }, 3000);

                    document.addEventListener('dblclick', () => {
                        window.location.href = 'page5distortion.html';
                    });
                }

                render() {
                    requestAnimationFrame(() => this.render());
                    this.controls.update();
                    this.composer.render();
                }
            }

            new App({ canvas: document.querySelector("#scene") });
        });
    </script>
</body>
</html>
